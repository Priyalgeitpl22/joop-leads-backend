// ============================================================================
// IMPROVED SCHEMA - Email Campaign Automation Platform
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

generator interfaces {
  provider = "prisma-generator-typescript-interfaces"
  output   = "../src/generated/interfaces"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  STOPPED
  COMPLETED
  ARCHIVED
}

enum LeadStatus {
  PENDING         // Not yet contacted
  QUEUED          // In queue to be sent
  SENT            // Email sent successfully
  OPENED          // Email was opened
  CLICKED         // Link was clicked
  REPLIED         // Lead replied
  POSITIVE_REPLY  // Positive reply
  BOUNCED         // Email bounced
  SENDER_BOUNCED  // Sender Bounced
  UNSUBSCRIBED    // Lead unsubscribed
  FAILED          // Failed to send
}

enum EmailSendStatus {
  QUEUED
  SENDING
  SENT
  FAILED
  BOUNCED
  OPENED
  CLICKED
  REPLIED
  STOPPED
}

enum SequenceType {
  EMAIL
  WAIT
  MANUAL_TASK
}

enum EmailProvider {
  smtp
  gmail
  outlook
  imap
}

enum WarmupStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  PAUSED
}

enum PlanCode {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum BillingPeriod {
  MONTHLY
  YEARLY
}

enum EventType {
  PENDING         // Not yet contacted
  QUEUED          // In queue to be sent
  SENT            // Email sent successfully
  OPENED          // Email was opened
  CLICKED         // Link was clicked
  REPLIED         // Lead replied
  POSITIVE_REPLY  // Positive reply
  BOUNCED         // Email bounced
  SENDER_BOUNCED  // Sender Bounced
  UNSUBSCRIBED    // Lead unsubscribed
  FAILED          // Failed to send
}

enum StopSending {
  CLICK
  OPEN
  REPLY
}

// ============================================================================
// CORE MODELS: Organization & Users
// ============================================================================

model Organization {
  id          String   @id @default(uuid())
  name        String
  domain      String?  @unique
  phone       String?
  address     String?
  city        String?
  state       String?
  country     String?
  zip         String?
  industry    String?
  description String?
  logoUrl     String?
  timezone    String   @default("UTC")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users          User[]
  senderAccounts SenderAccount[]
  campaigns      Campaign[]
  leads          Lead[]
  plans          OrganizationPlan[]
  apiKeys        ApiKey[]
  emailVerificationBatches EmailVerificationBatch[]
  @@index([domain])
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  fullName       String
  password       String
  phone          String?
  role           UserRole @default(MEMBER)
  profilePicture String?
  isVerified     Boolean  @default(false)
  isActive       Boolean  @default(true)
  isDeleted      Boolean  @default(false)
  lastLoginAt    DateTime?
  timezone       String?

  // Auth tokens
  otpCode                  String?
  otpExpiresAt             DateTime?
  resetToken               String?
  resetTokenExpiresAt      DateTime?
  activationToken          String?
  activationTokenExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // Relations
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  leadsUploaded Lead[]     @relation("UploadedByUser")
  campaigns     Campaign[] @relation("CreatedByUser")
  emailVerificationBatches EmailVerificationBatch[]
  @@index([orgId])
  @@index([email])
}

model AccessToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token])
  @@index([userId])
}

model ApiKey {
  id         String    @id @default(uuid())
  name       String
  key        String    @unique
  lastUsedAt DateTime?
  isActive   Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([key])
  @@index([orgId])
}

// ============================================================================
// SENDER ACCOUNTS (Email accounts used to send campaigns)
// ============================================================================

model SenderAccount {
  id       String        @id @default(uuid())
  accountId String       @unique
  email    String
  name     String?       // Display name
  provider EmailProvider 

  // SMTP Config
  smtpHost String?
  smtpPort Int?    @default(587)
  smtpUser String?
  smtpPass String?
  smtpSecure Boolean?

  // IMAP Config
  imapHost String?
  imapPort Int?    
  imapUser String?
  imapPass String?
  imapSecure Boolean?

  // OAuth Config (for Gmail/Outlook API)
  accessToken  String?   // Encrypted
  refreshToken String?   // Encrypted
  tokenExpiry  DateTime?

  // Limits & Settings
  dailyLimit      Int     @default(50)
  hourlyLimit     Int     @default(10)
  minDelaySeconds Int     @default(60) // Min gap between emails
  isEnabled       Boolean @default(true)
  isVerified      Boolean @default(false)

  // Warmup
  warmupStatus         WarmupStatus @default(NOT_STARTED)
  warmupStartedAt      DateTime?
  warmupDailyIncrement Int          @default(2)

  // Signature
  signature String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  runtime         SenderRuntime[]
  emailSends      EmailSend[]
  campaignSenders CampaignSender[]

  @@unique([accountId, email])
  @@index([orgId, isEnabled])
}

model SenderRuntime {
  id           String    @id @default(uuid())
  senderId     String
  dayKey       String    // YYYY-MM-DD
  sentToday    Int       @default(0)
  sentThisHour Int       @default(0)
  hourKey      String?   // YYYY-MM-DD-HH
  lastSentAt   DateTime?
  lockedAt     DateTime?
  lockedBy     String?   // Instance ID for distributed locking

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sender SenderAccount @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@unique([senderId, dayKey])
  @@index([senderId, dayKey])
}

// ============================================================================
// CAMPAIGNS
// ============================================================================

model Campaign {
  id          String         @id @default(uuid())
  name        String         @default("Untitled Campaign")
  description String?
  status      CampaignStatus @default(DRAFT)
  csvFile     String?
  // Schedule Settings
  timezone        String   @default("UTC")
  sendDays        String[] @default(["Mon", "Tue", "Wed", "Thu", "Fri"])
  windowStart     String   @default("09:00") // HH:mm
  windowEnd       String   @default("18:00") // HH:mm
  intervalMinutes Int      @default(5)       // Gap between emails
  maxEmailsPerDay Int      @default(100)     // Campaign daily limit

  sendAsPlainText Boolean @default(false) // Send emails without HTML formatting

  trackOpens  Boolean @default(true)  // Set to false to NOT track email opens
  trackClicks Boolean @default(true)  // Set to false to NOT track link clicks

  stopSending   StopSending @default(REPLY)

  sendingPriority Int @default(50)
  autoPauseSameDomain Boolean @default(false)

  bounceRateThreshold   Float   @default(5.0)  // Pause if bounce rate exceeds this percentage
  autoPauseOnHighBounce Boolean @default(true) // Enable auto-pause on high bounce rate

  includeUnsubscribeLink Boolean @default(true)
  unsubscribeText        String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  nextTrigger DateTime  @default(now())

  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdById String?
  createdBy   User?   @relation("CreatedByUser", fields: [createdById], references: [id], onDelete: SetNull)

  sequences   Sequence[]
  leads       CampaignLead[]
  senders     CampaignSender[]
  runtime     CampaignRuntime?
  analytics   CampaignAnalytics?
  emailSends  EmailSend[]
  triggerLogs CampaignTriggerLog[]

  @@index([orgId, status])
  @@index([status, createdAt])
}

// Junction table: Campaign <-> SenderAccount (many-to-many)
model CampaignSender {
  id         String  @id @default(uuid())
  campaignId String
  senderId   String
  weight     Int     @default(1) // For weighted distribution
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())

  campaign Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sender   SenderAccount @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@unique([campaignId, senderId])
  @@index([campaignId])
}

model CampaignRuntime {
  id         String    @id @default(uuid())
  campaignId String    @unique
  dayKey     String    // YYYY-MM-DD in campaign TZ
  sentToday  Int       @default(0)
  nextRunAt  DateTime
  lockedAt   DateTime?
  lockedBy   String?   // Instance ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([nextRunAt])
}

model CampaignAnalytics {
  id         String @id @default(uuid())
  campaignId String @unique

  totalLeads        Int @default(0)
  sentCount         Int @default(0)
  deliveredCount    Int @default(0)
  openedCount       Int @default(0)
  clickedCount      Int @default(0)
  repliedCount      Int @default(0)
  bouncedCount      Int @default(0)
  unsubscribedCount Int @default(0)
  failedCount       Int @default(0)

  // Rates (computed, stored for quick access)
  openRate   Float @default(0)
  clickRate  Float @default(0)
  replyRate  Float @default(0)
  bounceRate Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model CampaignTriggerLog {
  id         String   @id @default(uuid())
  campaignId String
  
  // Trigger timing
  triggeredAt   DateTime @default(now())  // When the trigger fired
  timezone      String                     // Campaign timezone at trigger time
  nextTriggerAt DateTime?                  // When the next trigger is scheduled
  
  // Email counts for this trigger
  totalEmailsSent    Int @default(0)       // Total emails queued in this trigger
  newLeadEmails      Int @default(0)       // First sequence emails (new leads)
  followUpEmails     Int @default(0)       // Follow-up sequence emails
  
  // Status and activity
  status        TriggerStatus @default(SUCCESS)
  activityLog   String?       // Detailed log message
  
  // Sender breakdown (JSON: { "sender@email.com": { sent: 5, skipped: "daily limit" } })
  senderDetails Json?
  
  // Lead details (JSON: [{ leadId, email, sequenceStep, status }])
  leadDetails   Json?
  
  // Performance
  durationMs    Int?          // How long the trigger took
  
  createdAt DateTime @default(now())
  
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  @@index([campaignId, triggeredAt])
  @@index([triggeredAt])
}

enum TriggerStatus {
  SUCCESS         // Trigger completed, emails sent
  PARTIAL         // Some emails sent, some skipped
  SKIPPED         // Trigger ran but no emails sent (outside schedule, limits reached, etc.)
  NO_PENDING      // No pending leads
  OUTSIDE_SCHEDULE // Outside send window
  DAILY_LIMIT     // Daily limit reached
  ERROR           // Error occurred
}

// ============================================================================
// SEQUENCES (Email steps in a campaign)
// ============================================================================

model Sequence {
  id         String       @id @default(uuid())
  campaignId String
  seqNumber  Int          // 1, 2, 3...
  type       SequenceType @default(EMAIL)

  // Delay before this step (from previous step or campaign start)
  delayDays    Int @default(0)
  delayHours   Int @default(0)
  delayMinutes Int @default(0)

  // For EMAIL type
  subject  String?
  bodyHtml String?
  bodyText String?

  // For MANUAL_TASK type
  taskTitle       String?
  taskDescription String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign   Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  emailSends EmailSend[]

  @@unique([campaignId, seqNumber])
  @@index([campaignId])
}

// ============================================================================
// LEADS (Recipients)
// ============================================================================

model Lead {
  id        String  @id @default(uuid())
  email     String
  firstName String?
  lastName  String?

  // Company info
  company     String?
  designation String?
  industry    String?
  linkedinUrl String?
  website     String?
  phone       String?

  // Location
  city    String?
  state   String?
  country String?

  // Custom fields (flexible)
  customFields Json?

  // Status
  isVerified     Boolean   @default(false) // Email verified
  isBlocked      Boolean   @default(false)
  isUnsubscribed Boolean   @default(false)
  unsubscribedAt DateTime?

  // Source tracking
  source   String? // csv_upload, api, manual, etc.
  fileName String? // Original CSV file name

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  uploadedById String?
  uploadedBy   User?   @relation("UploadedByUser", fields: [uploadedById], references: [id], onDelete: SetNull)

  campaigns  CampaignLead[]
  emailSends EmailSend[]
  events     EmailEvent[]

  @@unique([orgId, email])
  @@index([orgId, email])
  @@index([orgId, isUnsubscribed])
}

// Junction table: Campaign <-> Lead (with status tracking per campaign)
model CampaignLead {
  id         String     @id @default(uuid())
  campaignId String
  leadId     String
  status     LeadStatus @default(PENDING)

  // Track which sequence step we're at
  currentSequenceStep Int @default(0) // 0 = not started

  // Scheduling
  nextSendAt DateTime?

  // Stop sending flag - set when lead takes an action that triggers stop
  isStopped     Boolean   @default(false)
  stoppedAt     DateTime?
  stoppedReason String?   // "REPLY", "CLICK", "OPEN"

  // Last activity
  lastSentAt    DateTime?
  lastOpenedAt  DateTime?
  lastClickedAt DateTime?
  lastRepliedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  lead     Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([campaignId, leadId])
  @@index([campaignId, status])
  @@index([campaignId, nextSendAt])
}

// ============================================================================
// EMAIL SENDS & EVENTS (Tracking)
// ============================================================================

model EmailSend {
  id     String          @id @default(uuid())
  status EmailSendStatus @default(QUEUED)

  // Which sequence step was used
  sequenceStep Int?

  // Provider response
  providerMsgId String?
  threadId      String?

  // Error tracking
  errorMessage  String?
  errorCode     String?
  attempts      Int       @default(0)
  lastAttemptAt DateTime?

  // Reply tracking
  replyText     String?   @db.Text
  repliedAt     DateTime?

  // Timestamps
  queuedAt DateTime  @default(now())
  sentAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  senderId String
  sender   SenderAccount @relation(fields: [senderId], references: [id], onDelete: Cascade)

  leadId String
  lead   Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  sequenceId String?
  sequence   Sequence? @relation(fields: [sequenceId], references: [id], onDelete: SetNull)

  events EmailEvent[]

  @@unique([campaignId, leadId, sequenceStep]) // One email per lead per step
  @@index([campaignId, status])
  @@index([senderId, createdAt])
  @@index([status, queuedAt])
}

model EmailEvent {
  id        String    @id @default(uuid())
  type      EventType
  timestamp DateTime  @default(now())

  // Additional data
  ipAddress String?
  userAgent String?
  linkUrl   String? // For CLICKED events

  // Location (from IP)
  city    String?
  country String?

  createdAt DateTime @default(now())

  // Relations
  emailSendId String
  emailSend   EmailSend @relation(fields: [emailSendId], references: [id], onDelete: Cascade)

  leadId String
  lead   Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([emailSendId])
  @@index([leadId, type])
  @@index([timestamp])
}

// ============================================================================
// BILLING & PLANS
// ============================================================================

model Plan {
  id             Int      @id @default(autoincrement())
  code           PlanCode @unique
  name           String
  description    String?
  priceMonthly   Decimal?
  priceYearly    Decimal?
  isContactSales Boolean  @default(false)

  // Limits (null = unlimited)
  maxUsers          Int?
  maxSenderAccounts Int?
  maxLeadsPerMonth  Int?
  maxEmailsPerMonth Int?
  maxCampaigns      Int?

  // Features
  hasEmailVerification Boolean @default(false)
  hasEmailWarmup       Boolean @default(true)
  hasUnifiedInbox      Boolean @default(false)
  hasApiAccess         Boolean @default(false)
  hasCustomDomain      Boolean @default(false)
  hasAdvancedAnalytics Boolean @default(false)
  hasPrioritySupport   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions OrganizationPlan[]
}

model OrganizationPlan {
  id            Int           @id @default(autoincrement())
  orgId         String
  planId        Int
  billingPeriod BillingPeriod @default(MONTHLY)

  isActive Boolean   @default(true)
  startsAt DateTime  @default(now())
  endsAt   DateTime?

  // Current period usage
  emailsSentThisPeriod Int @default(0)
  leadsAddedThisPeriod Int @default(0)

  // Stripe/Payment info
  stripeCustomerId     String?
  stripeSubscriptionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  plan         Plan         @relation(fields: [planId], references: [id])

  @@unique([orgId, isActive]) // Only one active plan per org
  @@index([orgId])
}

model EmailVerificationBatch {
  id            String   @id @default(uuid())
  name          String
  fileName      String
  totalEmails   Int
  verifiedCount Int      @default(0)
  status        BatchStatus @default(PENDING)
  reoonTaskId   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  orgId         String
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  uploadedById  String
  uploadedBy    User @relation(fields: [uploadedById], references: [id])
  
  emails        VerifiedEmail[]
  
  @@index([orgId])
  @@index([uploadedById])
  @@map("email_verification_batches")
}

model VerifiedEmail {
  id                  String   @id @default(uuid())
  batchId             String
  email               String
  status              EmailStatus?
  username            String?
  domain              String?
  isSafeToSend        Boolean?
  isDeliverable       Boolean?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  batch               EmailVerificationBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  
  @@index([batchId])
  @@index([email])
  @@index([status])
  @@map("verified_emails")
}

enum BatchStatus {
  PENDING
  UPLOADING
  PROCESSING
  COMPLETED
  FAILED
}

enum EmailStatus {
  SAFE
  INVALID
  DISABLED
  DISPOSABLE
  INBOX_FULL
  CATCH_ALL
  ROLE_ACCOUNT
  SPAMTRAP
  UNKNOWN
}