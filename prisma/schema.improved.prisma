// ============================================================================
// IMPROVED SCHEMA - Email Campaign Automation Platform
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum LeadStatus {
  PENDING      // Not yet contacted
  QUEUED       // In queue to be sent
  SENT         // Email sent successfully
  OPENED       // Email was opened
  CLICKED      // Link was clicked
  REPLIED      // Lead replied
  BOUNCED      // Email bounced
  UNSUBSCRIBED // Lead unsubscribed
  FAILED       // Failed to send
}

enum EmailSendStatus {
  QUEUED
  SENDING
  SENT
  FAILED
  BOUNCED
}

enum SequenceType {
  EMAIL
  WAIT
  MANUAL_TASK
}

enum EmailProvider {
  SMTP
  GMAIL_API
  OUTLOOK_API
  SENDGRID
  AWS_SES
}

enum WarmupStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  PAUSED
}

enum PlanCode {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum BillingPeriod {
  MONTHLY
  YEARLY
}

enum EventType {
  SENT
  DELIVERED
  OPENED
  CLICKED
  REPLIED
  BOUNCED
  UNSUBSCRIBED
  COMPLAINED
}

// ============================================================================
// CORE MODELS: Organization & Users
// ============================================================================

model Organization {
  id          String   @id @default(uuid())
  name        String
  domain      String?  @unique
  phone       String?
  address     String?
  city        String?
  state       String?
  country     String?
  zip         String?
  industry    String?
  description String?
  logoUrl     String?
  timezone    String   @default("UTC")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users          User[]
  senderAccounts SenderAccount[]
  campaigns      Campaign[]
  leads          Lead[]
  plans          OrganizationPlan[]
  apiKeys        ApiKey[]

  @@index([domain])
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  fullName       String
  password       String
  phone          String?
  role           UserRole @default(MEMBER)
  profilePicture String?
  isVerified     Boolean  @default(false)
  isActive       Boolean  @default(true)
  lastLoginAt    DateTime?
  timezone       String?

  // Auth tokens
  otpCode                  String?
  otpExpiresAt             DateTime?
  resetToken               String?
  resetTokenExpiresAt      DateTime?
  activationToken          String?
  activationTokenExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  leadsUploaded Lead[]     @relation("UploadedByUser")
  campaigns     Campaign[] @relation("CreatedByUser")

  @@index([orgId])
  @@index([email])
}

model AccessToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token])
  @@index([userId])
}

model ApiKey {
  id         String    @id @default(uuid())
  name       String
  key        String    @unique
  lastUsedAt DateTime?
  isActive   Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([key])
  @@index([orgId])
}

// ============================================================================
// SENDER ACCOUNTS (Email accounts used to send campaigns)
// ============================================================================

model SenderAccount {
  id       String        @id @default(uuid())
  email    String
  name     String?       // Display name
  provider EmailProvider @default(SMTP)

  // SMTP Config
  smtpHost String?
  smtpPort Int?    @default(587)
  smtpUser String?
  smtpPass String? // Encrypted

  // OAuth Config (for Gmail/Outlook API)
  accessToken  String?   // Encrypted
  refreshToken String?   // Encrypted
  tokenExpiry  DateTime?

  // Limits & Settings
  dailyLimit      Int     @default(50)
  hourlyLimit     Int     @default(10)
  minDelaySeconds Int     @default(60) // Min gap between emails
  isEnabled       Boolean @default(true)
  isVerified      Boolean @default(false)

  // Warmup
  warmupStatus         WarmupStatus @default(NOT_STARTED)
  warmupStartedAt      DateTime?
  warmupDailyIncrement Int          @default(2)

  // Signature
  signature String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  runtime         SenderRuntime[]
  emailSends      EmailSend[]
  campaignSenders CampaignSender[]

  @@unique([orgId, email])
  @@index([orgId, isEnabled])
}

model SenderRuntime {
  id           String    @id @default(uuid())
  senderId     String
  dayKey       String    // YYYY-MM-DD
  sentToday    Int       @default(0)
  sentThisHour Int       @default(0)
  hourKey      String?   // YYYY-MM-DD-HH
  lastSentAt   DateTime?
  lockedAt     DateTime?
  lockedBy     String?   // Instance ID for distributed locking

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sender SenderAccount @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@unique([senderId, dayKey])
  @@index([senderId, dayKey])
}

// ============================================================================
// CAMPAIGNS
// ============================================================================

model Campaign {
  id          String         @id @default(uuid())
  name        String         @default("Untitled Campaign")
  description String?
  status      CampaignStatus @default(DRAFT)

  // Schedule Settings
  timezone        String   @default("UTC")
  sendDays        String[] @default(["Mon", "Tue", "Wed", "Thu", "Fri"])
  windowStart     String   @default("09:00") // HH:mm
  windowEnd       String   @default("18:00") // HH:mm
  intervalMinutes Int      @default(5)       // Gap between emails
  maxEmailsPerDay Int      @default(100)     // Campaign daily limit

  // Tracking Settings
  trackOpens  Boolean @default(true)
  trackClicks Boolean @default(true)

  // Unsubscribe
  includeUnsubscribeLink Boolean @default(true)
  unsubscribeText        String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?

  // Relations
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdById String?
  createdBy   User?   @relation("CreatedByUser", fields: [createdById], references: [id], onDelete: SetNull)

  sequences  Sequence[]
  leads      CampaignLead[]
  senders    CampaignSender[]
  runtime    CampaignRuntime?
  analytics  CampaignAnalytics?
  emailSends EmailSend[]

  @@index([orgId, status])
  @@index([status, createdAt])
}

// Junction table: Campaign <-> SenderAccount (many-to-many)
model CampaignSender {
  id         String  @id @default(uuid())
  campaignId String
  senderId   String
  weight     Int     @default(1) // For weighted distribution
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())

  campaign Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sender   SenderAccount @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@unique([campaignId, senderId])
  @@index([campaignId])
}

model CampaignRuntime {
  id         String    @id @default(uuid())
  campaignId String    @unique
  dayKey     String    // YYYY-MM-DD in campaign TZ
  sentToday  Int       @default(0)
  nextRunAt  DateTime
  lockedAt   DateTime?
  lockedBy   String?   // Instance ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([nextRunAt])
}

model CampaignAnalytics {
  id         String @id @default(uuid())
  campaignId String @unique

  totalLeads        Int @default(0)
  sentCount         Int @default(0)
  deliveredCount    Int @default(0)
  openedCount       Int @default(0)
  clickedCount      Int @default(0)
  repliedCount      Int @default(0)
  bouncedCount      Int @default(0)
  unsubscribedCount Int @default(0)
  failedCount       Int @default(0)

  // Rates (computed, stored for quick access)
  openRate   Float @default(0)
  clickRate  Float @default(0)
  replyRate  Float @default(0)
  bounceRate Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

// ============================================================================
// SEQUENCES (Email steps in a campaign)
// ============================================================================

model Sequence {
  id         String       @id @default(uuid())
  campaignId String
  stepNumber Int          // 1, 2, 3...
  type       SequenceType @default(EMAIL)

  // Delay before this step (from previous step or campaign start)
  delayDays    Int @default(0)
  delayHours   Int @default(0)
  delayMinutes Int @default(0)

  // For EMAIL type
  subject  String?
  bodyHtml String?
  bodyText String?

  // For MANUAL_TASK type
  taskTitle       String?
  taskDescription String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign   Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  emailSends EmailSend[]

  @@unique([campaignId, stepNumber])
  @@index([campaignId])
}

// ============================================================================
// LEADS (Recipients)
// ============================================================================

model Lead {
  id        String  @id @default(uuid())
  email     String
  firstName String?
  lastName  String?

  // Company info
  company     String?
  jobTitle    String?
  linkedinUrl String?
  website     String?
  phone       String?

  // Location
  city    String?
  state   String?
  country String?

  // Custom fields (flexible)
  customFields Json?

  // Status
  isVerified     Boolean   @default(false) // Email verified
  isBlocked      Boolean   @default(false)
  isUnsubscribed Boolean   @default(false)
  unsubscribedAt DateTime?

  // Source tracking
  source   String? // csv_upload, api, manual, etc.
  fileName String? // Original CSV file name

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  uploadedById String?
  uploadedBy   User?   @relation("UploadedByUser", fields: [uploadedById], references: [id], onDelete: SetNull)

  campaigns  CampaignLead[]
  emailSends EmailSend[]
  events     EmailEvent[]

  @@unique([orgId, email])
  @@index([orgId, email])
  @@index([orgId, isUnsubscribed])
}

// Junction table: Campaign <-> Lead (with status tracking per campaign)
model CampaignLead {
  id         String     @id @default(uuid())
  campaignId String
  leadId     String
  status     LeadStatus @default(PENDING)

  // Track which sequence step we're at
  currentSequenceStep Int @default(0) // 0 = not started

  // Scheduling
  nextSendAt DateTime?

  // Last activity
  lastSentAt    DateTime?
  lastOpenedAt  DateTime?
  lastClickedAt DateTime?
  lastRepliedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  lead     Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([campaignId, leadId])
  @@index([campaignId, status])
  @@index([campaignId, nextSendAt])
}

// ============================================================================
// EMAIL SENDS & EVENTS (Tracking)
// ============================================================================

model EmailSend {
  id     String          @id @default(uuid())
  status EmailSendStatus @default(QUEUED)

  // Which sequence step was used
  sequenceStep Int?

  // Provider response
  providerMsgId String?
  threadId      String?

  // Error tracking
  errorMessage  String?
  errorCode     String?
  attempts      Int       @default(0)
  lastAttemptAt DateTime?

  // Timestamps
  queuedAt DateTime  @default(now())
  sentAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  senderId String
  sender   SenderAccount @relation(fields: [senderId], references: [id], onDelete: Cascade)

  leadId String
  lead   Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  sequenceId String?
  sequence   Sequence? @relation(fields: [sequenceId], references: [id], onDelete: SetNull)

  events EmailEvent[]

  @@unique([campaignId, leadId, sequenceStep]) // One email per lead per step
  @@index([campaignId, status])
  @@index([senderId, createdAt])
  @@index([status, queuedAt])
}

model EmailEvent {
  id        String    @id @default(uuid())
  type      EventType
  timestamp DateTime  @default(now())

  // Additional data
  ipAddress String?
  userAgent String?
  linkUrl   String? // For CLICKED events

  // Location (from IP)
  city    String?
  country String?

  createdAt DateTime @default(now())

  // Relations
  emailSendId String
  emailSend   EmailSend @relation(fields: [emailSendId], references: [id], onDelete: Cascade)

  leadId String
  lead   Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([emailSendId])
  @@index([leadId, type])
  @@index([timestamp])
}

// ============================================================================
// BILLING & PLANS
// ============================================================================

model Plan {
  id             Int      @id @default(autoincrement())
  code           PlanCode @unique
  name           String
  description    String?
  priceMonthly   Decimal?
  priceYearly    Decimal?
  isContactSales Boolean  @default(false)

  // Limits (null = unlimited)
  maxUsers          Int?
  maxSenderAccounts Int?
  maxLeadsPerMonth  Int?
  maxEmailsPerMonth Int?
  maxCampaigns      Int?

  // Features
  hasEmailVerification Boolean @default(false)
  hasEmailWarmup       Boolean @default(true)
  hasUnifiedInbox      Boolean @default(false)
  hasApiAccess         Boolean @default(false)
  hasCustomDomain      Boolean @default(false)
  hasAdvancedAnalytics Boolean @default(false)
  hasPrioritySupport   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions OrganizationPlan[]
}

model OrganizationPlan {
  id            Int           @id @default(autoincrement())
  orgId         String
  planId        Int
  billingPeriod BillingPeriod @default(MONTHLY)

  isActive Boolean   @default(true)
  startsAt DateTime  @default(now())
  endsAt   DateTime?

  // Current period usage
  emailsSentThisPeriod Int @default(0)
  leadsAddedThisPeriod Int @default(0)

  // Stripe/Payment info
  stripeCustomerId     String?
  stripeSubscriptionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  plan         Plan         @relation(fields: [planId], references: [id])

  @@unique([orgId, isActive]) // Only one active plan per org
  @@index([orgId])
}
